#!/usr/bin/perl
use strict;
use warnings;

if(`whoami` eq "root\n"){
  exec "su", "user", "-c", "source /etc/profile; $0 @ARGV";
}

my $type = shift() || '';
die "Usage: $0 [sms|call]\n" if $type !~ /^(sms|call)$/;

my $dest = "/home/user/MyDocs/backup-$type";
my $exec = "${type}backuprestore";

sub run(@){
  print "@_\n";
  system @_;
}

run "mkdir -p $dest";
my $name = `date +%Y_%m_%d-%s`;
chomp $name;

my $cmd = "$exec export $dest/$name.$type 2>&1";
open CMD, "$cmd |";
my $line;
while($line = <CMD>){
  if($line =~ /Not cleaning up obsolete resources for nao:hasTag/){
    next;
  }
  print $line;
}
close CMD;

die "$exec failed\n" if $? != 0;

my @lines = `cat $dest/$name.$type`;
print "exported " . @lines . " items\n";
