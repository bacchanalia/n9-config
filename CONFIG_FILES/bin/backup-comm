#!/usr/bin/perl
use strict;
use warnings;

if(`whoami` eq "root\n"){
  exec "su", "user", "-c", "source /etc/profile; $0 @ARGV";
}

sub run(@){
  print "@_\n";
  system @_;
}

sub backupComm($$){
  my ($exec, $file) = @_;

  my $cmd = "timedkill 1200 $exec export $file 2>&1";
  open CMD, "$cmd |";
  my $line;
  while($line = <CMD>){
    if($line =~ /Not cleaning up obsolete resources for nao:hasTag/i){
      print '.';
    }elsif($line =~ /The task queue's background thread stalled/i){
      print $line;
      print "ugh libqtcontacts, killing $exec\n";
      run "pkill", $exec;
      close CMD;
      print "thread stall error\n";
      return 1;
    }else{
      print $line;
    }
  }
  close CMD;
  return $?;
}

sub main(@){
  my $type = shift() || '';
  my $file = shift();
  my $dest = "/home/user/MyDocs/backup-$type";
  my $exec = "${type}backuprestore";

  if(not defined $file){
    my $name = `date +%Y_%m_%d-%s`;
    chomp $name;
    $file = "$dest/$name.$type";
  }

  die "Usage: $0 sms|call [file]\n" if $type !~ /^(sms|call)$/ or @_ > 0;

  run "mkdir -p $dest";

  $| = 1; #autoflush
  my $exitCode = backupComm $exec, $file;

  die "\n$exec failed\n" if $exitCode != 0;

  my @lines = `cat $file`;
  print "\nexported " . @lines . " items\n";
}

&main(@ARGV);
